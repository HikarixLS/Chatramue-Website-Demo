var x=(V,g,l)=>new Promise((r,s)=>{var o=d=>{try{f(l.next(d))}catch(p){s(p)}},v=d=>{try{f(l.throw(d))}catch(p){s(p)}},f=d=>d.done?r(d.value):Promise.resolve(d.value).then(o,v);f((l=l.apply(V,g)).next())});import{r as k,c as $,o as D,u as E,s as A,K as O,e as i,h as c,g as t,F as w,p as Q,k as R,t as m,l as h,v as b,M as I,j as N,I as H,f as u}from"./vendor-cBPYqRmV.js";import{a as L,c as G,b as z,v as F,d as B}from"./index-obp5zDkU.js";const _={key:0,class:"checkout-container"},j={key:0,class:"loading-state"},K={class:"checkout-summary"},Y={class:"order-items"},J={class:"item-info"},W={class:"item-name"},X={key:0,class:"item-size"},Z={key:1,class:"item-options"},ee={key:2,class:"item-options"},te={key:3,class:"item-toppings"},ne={class:"item-price"},oe={class:"order-total"},le={class:"total-price"},ae={class:"payment-methods"},se={class:"payment-option"},re={class:"payment-option"},ie={key:0,class:"bank-info"},ue={class:"bank-details"},de={class:"qr-payment"},me={class:"qr-container"},ce={key:1,class:"error"},pe=["disabled"],fe={__name:"CheckOut",setup(V){const g=E(),l=L(),r=G(),{showNotification:s}=z(),o=k({fullName:"",phone:"",email:"",address:"",notes:"",paymentMethod:"cod"}),v=k(""),f=k(!0),d=k(!1),p=k(!1),C=k(null);$(()=>{const a={bank:"Techcombank",accountNumber:"19039566880010",accountName:"CONG TY TNHH CHATRAMUE VIETNAM",amount:l.totalPrice,content:`Thanh toan don hang ChaTraMue ${Date.now()}`};return`2|99|${a.accountNumber}|${a.accountName}|${a.bank}|${a.amount}|${a.content}|VND`}),D(()=>x(null,null,function*(){if(yield new Promise(a=>setTimeout(a,100)),!r.isAuthenticated){p.value=!0,s("Vui lòng đăng nhập để thanh toán","warning"),g.push({path:"/login",query:{redirect:"/checkout"}});return}if(l.items.length===0){p.value=!0,s("Giỏ hàng của bạn đang trống","warning"),g.push("/products");return}r.user&&(o.value.fullName=r.user.fullName||"",o.value.phone=r.user.phone||"",o.value.email=r.user.email||"",o.value.address=r.user.address||""),f.value=!1,d.value=!0,yield A(),M()})),O(()=>o.value.paymentMethod,a=>x(null,null,function*(){a==="bank"&&(yield A(),M())}));const M=()=>{if(!C.value){console.log("Canvas not found");return}const a=C.value,e=a.getContext("2d");console.log("Generating QR code..."),console.log("Total amount:",l.totalPrice),a.width=200,a.height=200,e.clearRect(0,0,200,200),e.fillStyle="#f8f9fa",e.fillRect(0,0,200,200),e.fillStyle="#333",e.font="14px Arial",e.textAlign="center",e.fillText("Đang tạo QR...",100,100);const n=l.totalPrice,y=`Thanh toan don hang ChaTraMue ${Date.now()}`,q=`https://img.vietqr.io/image/TCB-19039566880010-qr_only.png?amount=${n}&addInfo=${encodeURIComponent(y)}`;console.log("QR URL:",q);const T=new Image;T.crossOrigin="anonymous",T.onload=()=>{console.log("QR image loaded successfully"),e.clearRect(0,0,200,200),e.drawImage(T,0,0,200,200)},T.onerror=U=>{console.error("QR API error:",U),e.clearRect(0,0,200,200),e.fillStyle="#f0f0f0",e.fillRect(0,0,200,200),e.strokeStyle="#ddd",e.strokeRect(0,0,200,200),e.fillStyle="#333",e.font="11px Arial",e.textAlign="center",e.fillText("QR Code VietQR",100,25),e.fillText("Techcombank",100,45),e.fillText("STK: 19039566880010",100,65),e.fillText(`Số tiền: ${n.toLocaleString()}đ`,100,85),e.fillText("CHATRAMUE VIETNAM",100,105),e.fillText("─────────────",100,125),e.fillText("Mở app ngân hàng",100,145),e.fillText("để quét mã QR",100,165)},T.src=q},S=a=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(a),P=()=>{if(!r.isAuthenticated){s("Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.","error"),g.push("/login");return}if(l.items.length===0){v.value="Giỏ hàng của bạn đang trống",s("Giỏ hàng của bạn đang trống","error");return}for(let n of l.items){const y=F(n);if(y){s(`Sản phẩm không hợp lệ: ${y}`,"error");return}}const a=B(o.value);if(!a.isValid){const n=Object.values(a.errors)[0];v.value=n,s(n,"error");return}if(l.totalPrice<1e4){s("Đơn hàng tối thiểu 10,000 VNĐ","error");return}if(l.totalPrice>5e6){s("Đơn hàng không được vượt quá 5,000,000 VNĐ","error");return}const e={userId:r.user.id,items:l.items,total:l.totalPrice,customer:o.value,orderDate:new Date().toISOString(),status:"pending"};try{r.addOrder(e),l.clearCart(),s("Đặt hàng thành công! Chúng tôi sẽ liên hệ với bạn sớm nhất.","success",5e3),g.push("/")}catch(n){s("Có lỗi xảy ra khi đặt hàng. Vui lòng thử lại.","error")}};return(a,e)=>p.value?c("",!0):(u(),i("div",_,[f.value?(u(),i("div",j,e[7]||(e[7]=[t("p",null,"Đang tải thông tin...",-1)]))):d.value?(u(),i(w,{key:1},[t("div",K,[e[9]||(e[9]=t("h3",null,"Đơn hàng của bạn",-1)),t("div",Y,[(u(!0),i(w,null,Q(R(l).items,n=>(u(),i("div",{key:n.cartId||n.id,class:"order-item"},[t("div",J,[t("div",W,m(n.name)+" x"+m(n.quantity),1),n.size&&n.size.value?(u(),i("div",X," Size: "+m(n.size.value),1)):c("",!0),n.iceLevel?(u(),i("div",Z," Đá: "+m(n.iceLevel.name),1)):c("",!0),n.sugarLevel?(u(),i("div",ee," Đường: "+m(n.sugarLevel.name),1)):c("",!0),n.selectedToppings&&n.selectedToppings.length>0?(u(),i("div",te," + "+m(n.selectedToppings.map(y=>y.name).join(", ")),1)):c("",!0)]),t("div",ne,m(S((n.totalPrice||n.price)*n.quantity)),1)]))),128)),t("div",oe,[e[8]||(e[8]=t("div",{class:"total-label"},"Tổng cộng:",-1)),t("div",le,m(S(R(l).totalPrice)),1)])])]),t("form",{class:"checkout-form",onSubmit:H(P,["prevent"])},[e[18]||(e[18]=t("h3",null,"Thông tin giao hàng",-1)),e[19]||(e[19]=t("label",{for:"fullName"},"Họ và tên:",-1)),h(t("input",{type:"text",id:"fullName","onUpdate:modelValue":e[0]||(e[0]=n=>o.value.fullName=n),required:""},null,512),[[b,o.value.fullName]]),e[20]||(e[20]=t("label",{for:"phone"},"Số điện thoại:",-1)),h(t("input",{type:"tel",id:"phone","onUpdate:modelValue":e[1]||(e[1]=n=>o.value.phone=n),required:""},null,512),[[b,o.value.phone]]),e[21]||(e[21]=t("label",{for:"email"},"Email:",-1)),h(t("input",{type:"email",id:"email","onUpdate:modelValue":e[2]||(e[2]=n=>o.value.email=n),required:""},null,512),[[b,o.value.email]]),e[22]||(e[22]=t("label",{for:"address"},"Địa chỉ giao hàng:",-1)),h(t("input",{type:"text",id:"address","onUpdate:modelValue":e[3]||(e[3]=n=>o.value.address=n),required:""},null,512),[[b,o.value.address]]),e[23]||(e[23]=t("h4",null,"Phương thức thanh toán",-1)),t("div",ae,[t("label",se,[h(t("input",{type:"radio",id:"payment-cod","onUpdate:modelValue":e[4]||(e[4]=n=>o.value.paymentMethod=n),value:"cod",name:"payment"},null,512),[[I,o.value.paymentMethod]]),e[10]||(e[10]=t("span",null,"Thanh toán khi nhận hàng (COD)",-1))]),t("label",re,[h(t("input",{type:"radio",id:"payment-bank","onUpdate:modelValue":e[5]||(e[5]=n=>o.value.paymentMethod=n),value:"bank",name:"payment"},null,512),[[I,o.value.paymentMethod]]),e[11]||(e[11]=t("span",null,"Chuyển khoản ngân hàng",-1))])]),o.value.paymentMethod==="bank"?(u(),i("div",ie,[e[17]||(e[17]=t("h5",null,"Thông tin chuyển khoản:",-1)),t("div",ue,[e[13]||(e[13]=t("p",null,[t("strong",null,"Ngân hàng:"),N(" Techombank")],-1)),e[14]||(e[14]=t("p",null,[t("strong",null,"Số tài khoản:"),N(" 19039566880010")],-1)),e[15]||(e[15]=t("p",null,[t("strong",null,"Chủ tài khoản:"),N(" CONG TY TNHH CHATRAMUE VIETNAM")],-1)),e[16]||(e[16]=t("p",null,[t("strong",null,"Nội dung:"),N(" Thanh toan don hang #[Mã đơn hàng]")],-1)),t("div",de,[e[12]||(e[12]=t("p",null,[t("em",null,"Hoặc quét mã QR để thanh toán nhanh:")],-1)),t("div",me,[t("canvas",{ref_key:"qrCodeCanvas",ref:C,class:"qr-code"},null,512)])])])])):c("",!0),e[24]||(e[24]=t("label",{for:"notes"},"Ghi chú (tùy chọn):",-1)),h(t("input",{type:"text",id:"notes","onUpdate:modelValue":e[6]||(e[6]=n=>o.value.notes=n)},null,512),[[b,o.value.notes]]),v.value?(u(),i("div",ce,m(v.value),1)):c("",!0),t("button",{type:"submit",class:"checkout-btn",disabled:R(l).items.length===0}," Đặt hàng ",8,pe)],32)],64)):c("",!0)]))}};export{fe as default};
