var C=(S,m,c)=>new Promise((h,g)=>{var _=o=>{try{d(c.next(o))}catch(i){g(i)}},l=o=>{try{d(c.throw(o))}catch(i){g(i)}},d=o=>o.done?h(o.value):Promise.resolve(o.value).then(_,l);d((c=c.apply(S,m)).next())});import{r as w,c as x,J as I,o as O,e as r,g as t,i as $,t as p,F as y,p as b,j as k,k as P,l as z,v as E,w as G,b as J,u as L,f as u,n as N}from"./vendor-cBPYqRmV.js";import{a as q,c as K,u as U,b as W}from"./index-obp5zDkU.js";import{_ as H}from"./ToppingModal-CIWEQAZ8.js";const Q={key:0,class:"product-detail"},X={class:"product-image"},Y=["src","alt"],Z={class:"product-info"},tt={class:"content"},et={class:"rating-summary"},st={class:"stars"},nt={class:"rating-text"},at={class:"description"},ot={class:"reviews-section"},it={key:0,class:"write-review"},lt={class:"rating-input"},rt={class:"stars-input"},ut=["onClick"],ct={key:1,class:"login-prompt"},dt={class:"reviews-list"},vt={class:"review-header"},pt={class:"stars"},gt={class:"review-date"},mt={class:"review-comment"},ht={key:1},bt={__name:"ProductDetail",setup(S){const m=I(),c=L(),h=q(),g=K(),_=U(),{showNotification:l}=W(),d=w(!1),o=w(!1),i=w([]),v=w({rating:5,comment:""}),D=()=>C(null,null,function*(){try{const e=yield fetch(`http://localhost:3001/reviews?productId=${m.params.id}`);i.value=yield e.json()}catch(e){console.error("Error loading reviews:",e)}}),V=x(()=>{if(i.value.length===0)return 0;const e=i.value.reduce((s,f)=>s+f.rating,0);return Math.round(e/i.value.length*10)/10}),A=()=>C(null,null,function*(){if(!v.value.comment.trim()){l("Vui lòng nhập bình luận","error");return}try{const e={productId:parseInt(m.params.id),userId:g.user.id,userName:g.user.fullName,rating:v.value.rating,comment:v.value.comment,createdAt:new Date().toISOString()};(yield fetch("http://localhost:3001/reviews",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok&&(l("Đánh giá đã được gửi thành công!","success"),v.value={rating:5,comment:""},D())}catch(e){l("Có lỗi xảy ra khi gửi đánh giá","error")}}),M=e=>new Date(e).toLocaleDateString("vi-VN"),n=x(()=>_.products.find(e=>e.slug===m.params.slug));O(()=>{_.initializeData(),D()});const R=e=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e),j=()=>{var e;o.value=!1,(e=n.value)!=null&&e.availableToppings&&n.value.availableToppings.length>0?d.value=!0:n.value&&(h.addToCart(n.value),l(`Đã thêm ${n.value.name} vào giỏ hàng`,"success"))},B=e=>{h.addToCartWithToppings(e);const s=e.selectedToppings.length>0?` với ${e.selectedToppings.map(f=>f.name).join(", ")}`:"";l(`Đã thêm ${e.name}${s} vào giỏ hàng`,"success"),o.value&&setTimeout(()=>{c.push("/checkout")},500)},F=()=>{var e;if(!g.isAuthenticated){l("Vui lòng đăng nhập để mua hàng","warning"),c.push({path:"/login",query:{redirect:"/checkout"}});return}o.value=!0,(e=n.value)!=null&&e.availableToppings&&n.value.availableToppings.length>0?d.value=!0:n.value&&(h.addToCart(n.value),l(`Đã thêm ${n.value.name} vào giỏ hàng`,"success"),setTimeout(()=>{c.push("/checkout")},500))};return(e,s)=>{const f=J("router-link");return n.value?(u(),r("section",Q,[t("div",X,[t("img",{src:n.value.image,alt:n.value.name},null,8,Y)]),t("div",Z,[t("div",tt,[t("h1",null,p(n.value.name),1),t("div",et,[t("div",st,[(u(),r(y,null,b(5,a=>t("i",{key:a,class:N(["fas fa-star",{filled:a<=V.value}])},null,2)),64))]),t("span",nt,p(V.value)+"/5 ("+p(i.value.length)+" đánh giá)",1)]),t("p",at,p(n.value.description),1),t("p",null,[s[2]||(s[2]=t("strong",null,"Giá:",-1)),k(" "+p(R(n.value.price)),1)]),t("div",{class:"button-group"},[t("button",{class:"btn",onClick:j},"Thêm vào giỏ hàng"),t("button",{class:"btn btn-primary",onClick:F},"Mua ngay")])])]),t("div",ot,[s[8]||(s[8]=t("h3",null,"Đánh giá sản phẩm",-1)),P(g).isAuthenticated?(u(),r("div",it,[s[4]||(s[4]=t("h4",null,"Viết đánh giá của bạn",-1)),t("div",lt,[s[3]||(s[3]=t("span",null,"Điểm đánh giá:",-1)),t("div",rt,[(u(),r(y,null,b(5,a=>t("i",{key:a,class:N(["fas fa-star",{filled:a<=v.value.rating}]),onClick:T=>v.value.rating=a},null,10,ut)),64))])]),z(t("textarea",{"onUpdate:modelValue":s[0]||(s[0]=a=>v.value.comment=a),placeholder:"Nhập bình luận của bạn...",rows:"4"},null,512),[[E,v.value.comment]]),t("button",{onClick:A,class:"btn btn-primary"},"Gửi đánh giá")])):(u(),r("div",ct,[t("p",null,[s[6]||(s[6]=k("Vui lòng ",-1)),$(f,{to:"/login"},{default:G(()=>s[5]||(s[5]=[k("đăng nhập",-1)])),_:1,__:[5]}),s[7]||(s[7]=k(" để viết đánh giá.",-1))])])),t("div",dt,[(u(!0),r(y,null,b(i.value,a=>(u(),r("div",{key:a.id,class:"review-item"},[t("div",vt,[t("strong",null,p(a.userName),1),t("div",pt,[(u(),r(y,null,b(5,T=>t("i",{key:T,class:N(["fas fa-star",{filled:T<=a.rating}])},null,2)),64))]),t("span",gt,p(M(a.createdAt)),1)]),t("p",mt,p(a.comment),1)]))),128))])]),$(H,{"is-visible":d.value,product:n.value,onClose:s[1]||(s[1]=a=>{d.value=!1,o.value=!1}),onAddToCart:B},null,8,["is-visible","product"])])):(u(),r("div",ht,s[9]||(s[9]=[t("p",null,"Không tìm thấy sản phẩm",-1)])))}}};export{bt as default};
